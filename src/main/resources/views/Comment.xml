<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_7.0.xsd">

  <grid name="portal-comment-grid" title="Portal comments"
    model="com.axelor.apps.base.db.Comment" orderBy="-createdOn">
    <field name="mailMessage"/>
  </grid>

  <form name="portal-comment-form" title="Portal comment"
    model="com.axelor.apps.base.db.Comment" width="large" onNew="action-portal-record-comment-onnew"
    onSave="action-portal-record-comment-onsave">
    <panel name="contentPanel" showIf="!$readonly()">
      <field name="mailMessage" colSpan="12" showTitle="false" canSelect="false"
        canRemove="false">
        <editor>
          <field name="subject" title="Subject" colSpan="12"/>
          <field name="messageContentHtml" title="Content" colSpan="12" widget="html"
            required="true"/>
        </editor>
      </field>
    </panel>
    <panel name="mailMessagePanel" showIf="$readonly()">
      <field name="mailMessage.subject" colSpan="10"/>
      <field name="$edited" colSpan="2" showIf="mailMessage.updatedOn" showTitle="false">
        <viewer><![CDATA[
          <><Badge bg="primary" fontSize={6}>{_t('Edited')}</Badge></>
         ]]></viewer>
      </field>
      <field name="mailMessage.author"/>
      <field name="mailMessage.createdOn"/>
      <field name="mailMessage.messageContentHtml" required="true" colSpan="12" widget="html"
        showTitle="false"/>
      <field name="mailMessage.updatedOn" hidden="true"/>
      <field name="mailMessage.body" hidden="true"/>
    </panel>
    <panel name="portalPanel" showIf="portalEvent || portalNews || forumPost" readonly="true">
      <field name="portalEvent" colSpan="12" showIf="portalEvent"/>
      <field name="portalNews" colSpan="12" showIf="portalNews"/>
      <field name="forumPost" colSpan="12" showIf="forumPost"/>
      <field name="parentComment" colSpan="12" hidden="true"/>
    </panel>
    <panel name="postAttachmentPanel">
      <field name="commentFileList" colSpan="12">
        <editor x-viewer="true">
          <field name="attachmentFile" showTitle="false" widget="binary-link" colSpan="4"
            required="true"/>
          <field name="description" showTitle="false" colSpan="8" widget="string"/>
        </editor>
      </field>
    </panel>
    <panel name="childCommentPanel" title="Replies">
      <spacer name="commentSpacer" colSpan="11"/>
      <button onClick="action-portal-portal-add-comment" name="addbtn" title="Add"
        colSpan="1" icon="plus-lg" showIf="!$readonly()"/>
      <panel-dashlet action="action-portal-portal-child-display-comment" colSpan="12"
        title=""/>
    </panel>
  </form>

  <action-view name="action-portal-portal-child-display-comment" title="Comments"
    model="com.axelor.apps.base.db.Comment">
    <view type="cards" name="comment-card"/>
    <view type="form" name="portal-comment-form"/>
    <domain>self.parentComment.id = :id</domain>
  </action-view>

  <action-record name="action-portal-record-comment-onsave"
    model="com.axelor.apps.base.db.Comment">
    <field name="mailMessage.author" expr="eval: __user__"/>
    <field name="mailMessage.relatedId" expr="eval: id"/>
    <field name="mailMessage.body" expr="eval: mailMessage.messageContentHtml"
      if="!mailMessage.body"/>
    <field name="mailMessage.relatedModel" expr="com.axelor.apps.portal.db.PortalEvent"
      if="portalEvent"/>
    <field name="mailMessage.relatedModel" expr="com.axelor.apps.portal.db.PortalNews"
      if="portalNews"/>
    <field name="mailMessage.relatedModel" expr="com.axelor.apps.portal.db.ForumPost"
      if="forumPost"/>
  </action-record>

  <action-view name="action-portal-portal-add-comment" title="Comment"
    model="com.axelor.apps.base.db.Comment">
    <view type="form" name="portal-comment-form"/>
    <view-param name="popup" value="reload"/>
    <view-param name="show-toolbar" value="false"/>
    <view-param name="forceEdit" value="true"/>
    <context name="_object" expr="eval: __this__"/>
    <context name="_parentModel" expr="eval: _model"/>
  </action-view>

  <action-record name="action-portal-record-comment-onnew"
    model="com.axelor.apps.base.db.Comment">
    <field name="portalNews" expr="eval: _object"
      if="_parentModel &amp;&amp; _parentModel == 'com.axelor.apps.portal.db.PortalNews'"/>
    <field name="portalEvent" expr="eval: _object"
      if="_parentModel &amp;&amp; _parentModel == 'com.axelor.apps.portal.db.PortalEvent'"/>
    <field name="forumPost" expr="eval: _object"
      if="_parentModel &amp;&amp; _parentModel == 'com.axelor.apps.portal.db.ForumPost'"/>
    <field name="parentComment" expr="eval: _object"
      if="_parentModel &amp;&amp; _parentModel == 'com.axelor.apps.base.db.Comment'"/>
  </action-record>

</object-views>